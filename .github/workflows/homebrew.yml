name: homebrew
on:
  release:  
    types: [released]
  workflow_dispatch: # Allow the workflow to be triggered also manually.

jobs:
  download-and-archive:
    runs-on: ubuntu-latest
    steps:
      - name: macOS/amd64 binary
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          curl -Lo copilot-darwin-amd64 https://github.com/efekarakus/github-release-playground/releases/download/${GITHUB_REF##*/}/copilot-darwin-amd64
          cp copilot-darwin-amd64 copilot
          chmod +x copilot
          tar czf copilot_${GITHUB_REF##*/}_macOS_amd64.tar.gz copilot
      - name: macOS/arm64 binary
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          curl -Lo copilot-darwin-arm64 https://github.com/efekarakus/github-release-playground/releases/download/${GITHUB_REF##*/}/copilot-darwin-arm64
          cp copilot-darwin-arm64 copilot
          chmod +x copilot
          tar czf copilot_${GITHUB_REF##*/}_macOS_arm64.tar.gz copilot
      - name: linux/amd64 binary
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          curl -Lo copilot-linux https://github.com/efekarakus/github-release-playground/releases/download/${GITHUB_REF##*/}/copilot-linux
          cp copilot-linux copilot
          chmod +x copilot
          tar czf copilot_${GITHUB_REF##*/}_linux_amd64.tar.gz copilot
      - name: Save archive files
        uses: actions/upload-artifact@v2
        with:
          name: save tar files
          path: '*.tar.gz'

  update-release:
    runs-on: ubuntu-latest
    needs: download-and-archive
    steps:
      - name: Download archive files
        uses: actions/download-artifact@v2
        with:
          name: save tar files
      - name: Update release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: '*.tar.gz'